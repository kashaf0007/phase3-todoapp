


<!--
Sync Impact Report:
- Version: 0.0.0 → 1.0.0 (Initial ratification)
- Principles Added: 14 principles established
- Sections Added: Core Principles, Technology Stack, REST API Contract, Authentication & Security,
  Monorepo Structure, Database Rules, Validation & Acceptance, Enforcement, Governance
- Templates Status:
  ✅ plan-template.md - Constitution Check section aligns (gate verification approach)
  ✅ spec-template.md - User stories and requirements align with spec-first principle
  ✅ tasks-template.md - Task structure aligns with incremental implementation principle
- Follow-up: None - all placeholders resolved
-->

# Todo Application Phase II Constitution

## Core Principles

### I. Spec-First Development (NON-NEGOTIABLE)

No code may be written or modified without an explicit specification. Claude Code MUST always read and reference specs using `@specs/...` notation. Specifications precede all implementation work without exception.

**Rationale**: Ensures all work is intentional, reviewable, and traceable to documented requirements, preventing scope creep and undocumented features.

### II. No Manual Coding

Humans do not write application code. All implementation MUST be generated by Claude Code from specifications. Manual coding violates the agentic development model.

**Rationale**: Maintains consistency, ensures AI-driven workflow integrity, and guarantees all code is traceable to specifications and agent decisions.

### III. Agentic Dev Stack Workflow

Claude Code MUST follow this exact sequence for all work:
1. Write or read spec
2. Generate implementation plan
3. Break into tasks
4. Implement incrementally
5. Validate against acceptance criteria

**Rationale**: Standardizes development flow, ensures planning precedes implementation, and provides validation gates at each stage.

### IV. Phase Isolation

Only Phase II scope is allowed. Intermediate and Advanced features (priorities, tags, search, filtering, sorting, recurring tasks, due dates, reminders, AI features, chatbot, RBAC, file uploads, push notifications) are explicitly FORBIDDEN unless added by a new spec.

**Rationale**: Prevents scope creep, maintains focus on current objectives, and ensures incremental delivery of testable functionality.

### V. Multi-User Authentication

The system MUST support multiple authenticated users. User signup and signin are mandatory. Better Auth (Next.js) handles frontend authentication. JWT-based authentication provides backend authorization.

**Rationale**: Establishes foundation for production-grade multi-user application with secure identity management.

### VI. Data Persistence

All application data MUST persist in Neon Serverless PostgreSQL. No in-memory or file-based storage for production data. SQLModel is the exclusive ORM.

**Rationale**: Ensures data durability, scalability, and consistency across user sessions and application restarts.

### VII. Strict User Isolation

Each task MUST belong to exactly one authenticated user. Backend MUST enforce user isolation on every CRUD operation. Users can ONLY read and write their own tasks.

**Rationale**: Core security requirement preventing unauthorized data access and ensuring data privacy in multi-user environment.

### VIII. JWT Security

Backend MUST NEVER trust client-provided user IDs. The backend MUST derive user identity from verified JWT tokens only. All database queries MUST filter by authenticated user ID extracted from token.

**Rationale**: Prevents authentication bypass attacks and ensures server-side authority over user identity verification.

### IX. Technology Stack Immutability

The technology stack is immutable. Claude Code MUST NOT substitute technologies:
- Frontend: Next.js 16+ (App Router)
- Backend: Python FastAPI
- ORM: SQLModel
- Database: Neon Serverless PostgreSQL
- Auth: Better Auth + JWT
- Specs: Spec-Kit Plus
- AI Dev Tool: Claude Code

**Rationale**: Maintains consistency, prevents integration issues, and ensures all team members work with agreed-upon technologies.

### X. REST API Contract Compliance

All APIs MUST follow the binding REST API contract exactly:
- GET /api/{user_id}/tasks - List all tasks
- POST /api/{user_id}/tasks - Create task
- GET /api/{user_id}/tasks/{id} - Task details
- PUT /api/{user_id}/tasks/{id} - Update task
- DELETE /api/{user_id}/tasks/{id} - Delete task
- PATCH /api/{user_id}/tasks/{id}/complete - Toggle completion

**Critical Security Rule**: Even though user_id exists in URL path, backend MUST derive real user from JWT token, NOT from path parameter.

**Rationale**: Ensures consistent API design and prevents path parameter injection attacks by enforcing JWT-based user identification.

### XI. Shared Secret Management

JWT signing and verification MUST use `BETTER_AUTH_SECRET` environment variable. Frontend and backend MUST share the same secret. Secrets MUST NEVER be hardcoded.

**Rationale**: Enables JWT verification across services while maintaining secure secret management practices.

### XII. Monorepo Structure Integrity

Claude Code MUST respect and preserve this exact structure:
```
hackathon-todo/
├── .spec-kit/
├── specs/
│   ├── overview.md
│   ├── architecture.md
│   ├── features/
│   ├── api/
│   ├── database/
│   └── ui/
├── CLAUDE.md
├── frontend/
│   └── CLAUDE.md
├── backend/
│   └── CLAUDE.md
├── docker-compose.yml
└── README.md
```

Specs MUST NEVER live next to code. Claude Code MUST always read the closest CLAUDE.md for context-specific rules.

**Rationale**: Maintains clear separation between specifications and implementation, enables independent evolution of docs and code.

### XIII. CLAUDE.md Hierarchy

Claude Code MUST obey instruction hierarchy:
- Root CLAUDE.md → global rules (highest authority after this Constitution)
- /frontend/CLAUDE.md → frontend-specific patterns
- /backend/CLAUDE.md → backend-specific patterns
- /backend/CLAUDE.md → backend-specific patterns
If instructions conflict: Root > Folder > Spec

**Rationale**: Establishes clear precedence for resolving conflicting guidance across documentation layers.

### XIV. Database Schema Compliance

Use SQLModel ONLY. No raw SQL unless explicitly specified in a spec. Database schema MUST match `@specs/database/schema.md`. Every task row MUST include `user_id` for ownership enforcement.

**Rationale**: Ensures type-safe database interactions, prevents SQL injection, and enforces user isolation at data layer.

## Technology Stack (Immutable)


| Layer | Technology |
|-------|-----------|
| Frontend | Next.js 16+ (App Router) |
| Backend | Python FastAPI |
| ORM | SQLModel |
| Database | Neon Serverless PostgreSQL |
| Auth | Better Auth + JWT |
| Specs | Spec-Kit Plus |
| AI Dev Tool | Claude Code |

**Enforcement**: Claude Code MUST NOT substitute any technology in this stack.

## REST API Contract (Binding)

All endpoints MUST implement this exact contract:

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | /api/{user_id}/tasks | List all user tasks |
| POST | /api/{user_id}/tasks | Create new task |
| GET | /api/{user_id}/tasks/{id} | Get task details |
| PUT | /api/{user_id}/tasks/{id} | Update task |
| DELETE | /api/{user_id}/tasks/{id} | Delete task |
| PATCH | /api/{user_id}/tasks/{id}/complete | Toggle task completion |

**Critical Security Rule**: Backend MUST ignore `{user_id}` path parameter and MUST derive user identity exclusively from verified JWT token.

## Authentication & Security Constitution

### JWT Rules (Mandatory)

1. Better Auth MUST issue JWT tokens
2. Frontend MUST attach JWT to every API request: `Authorization: Bearer <token>`
3. FastAPI backend MUST verify JWT signature on every request
4. Backend MUST extract user identity from verified token payload
5. All database queries MUST filter by authenticated user ID from token

### Shared Secret Rule

- JWT signing and verification MUST use `BETTER_AUTH_SECRET` environment variable
- Secret MUST be provided via environment variables (never hardcoded)
- Frontend and backend MUST share identical secret value

### Authorization Enforcement

Claude Code MUST ensure:
- Requests without valid token → 401 Unauthorized
- Users can ONLY read/write their own tasks
- Task ownership verified on EVERY CRUD operation
- Token verification happens before any business logic

## Monorepo Constitution (Mandatory Structure)

```
hackathon-todo/
├── .spec-kit/              # Spec-Kit Plus framework files
├── specs/                  # All specifications (NEVER in code directories)
│   ├── overview.md
│   ├── architecture.md
│   ├── features/
│   ├── api/
│   ├── database/
│   └── ui/
├── CLAUDE.md              # Root agent instructions (highest precedence)
├── frontend/              # Next.js application
│   └── CLAUDE.md          # Frontend-specific agent instructions
├── backend/               # FastAPI application
│   └── CLAUDE.md          # Backend-specific agent instructions
├── docker-compose.yml     # Service orchestration
└── README.md             # Project documentation
```

**Rules**:
- Specifications live exclusively in `specs/` directory
- Code lives exclusively in `frontend/` and `backend/`
- CLAUDE.md files provide layer-specific guidance
- No cross-contamination between specs and code directories

## Database Rules

1. **ORM Exclusive**: Use SQLModel ONLY
2. **No Raw SQL**: Unless explicitly required by specification
3. **Schema Authority**: Database schema MUST match `@specs/database/schema.md`
4. **Ownership Column**: Every task table row MUST include `user_id` column
5. **Query Filtering**: All queries MUST filter by authenticated user ID
6. **Type Safety**: Leverage SQLModel's type checking for all database operations

## Validation & Acceptance Criteria

Claude Code MUST consider Phase II complete ONLY if ALL criteria pass:

1. **Feature Completeness**: All 5 Basic Level features work end-to-end
   - Add Task
   - View Task List
   - Update Task
   - Delete Task
   - Mark Task as Complete

2. **User Isolation**: Authenticated users ONLY see their own tasks (verified by test)

3. **JWT Enforcement**: JWT verification enforced on every backend endpoint

4. **Service Integration**: Frontend + backend run successfully together via docker-compose

5. **Spec Compliance**: All behavior exactly matches specifications

6. **Security Testing**: Authorization bypass attempts fail (manual verification)

## Enforcement Clause

If Claude Code violates ANY of these principles, the implementation is INVALID and MUST be redone:

- Skips specifications → INVALID
- Implements out-of-scope features → INVALID
- Allows manual code writing → INVALID
- Breaks security rules → INVALID
- Violates stack constraints → INVALID
- Trusts client-provided user IDs → INVALID

**Remediation Process**:
1. Identify violation in code review
2. Document violation type and location
3. Revert non-compliant changes
4. Create/update specification if needed
5. Re-implement following correct process


### Constitution Authority

This Constitution is the HIGHEST authority for Phase II. If any instruction conflicts with this Constitution, the Constitution overrides.

### Amendment Procedure

1. Amendments require documented rationale and migration plan
2. Version MUST increment according to semantic versioning:
   - **MAJOR**: Backward-incompatible governance changes, principle removals
   - **MINOR**: New principles added, material expansions
   - **PATCH**: Clarifications, wording fixes, non-semantic refinements
3. All affected specifications and plans MUST be reviewed and updated
4. Amendment date MUST be recorded in constitution metadata

### Compliance Review

- All code reviews MUST verify Constitutional compliance
- Spec-first workflow MUST be validated at PR review
- Security rules MUST pass automated and manual verification
- Phase isolation MUST be enforced (out-of-scope features rejected)
- Complexity MUST be justified against Constitutional principles

### Runtime Development Guidance

For operational development guidance, Claude Code MUST reference:
- Root `CLAUDE.md` - Global development patterns and workflows
- Layer-specific `CLAUDE.md` files - Frontend/backend implementation patterns
- This Constitution - Non-negotiable governance rules

**Version**: 1.0.0 | **Ratified**: 2025-12-30 | **Last Amended**: 2025-12-30

