# Implementation Plan: Logout Button

**Branch**: `002-logout` | **Date**: 2025-12-31 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `specs/002-logout/spec.md`

## Summary

Add a Logout button to the Todo List page that securely ends the user's session through client-side token removal. When clicked, the button will clear JWT tokens and user data from localStorage, reset React Query cache, and redirect to the Login page. The logout functionality uses a stateless JWT approach requiring no backend endpoint.

## Technical Context

**Language/Version**: TypeScript (Next.js 16+), Python 3.11 (FastAPI backend - not modified for this feature)
**Primary Dependencies**: Next.js App Router, React 18, TanStack React Query v5, Custom auth-client.ts
**Storage**: localStorage for JWT tokens and user data (client-side only)
**Testing**: Manual testing of logout flow, React Query cache clearing, route protection
**Target Platform**: Web browsers (Chrome, Firefox, Safari, Edge)
**Project Type**: Web application (frontend modification only)
**Performance Goals**: Logout completes in under 2 seconds
**Constraints**: No backend changes required (stateless JWT), must work offline after initial load
**Scale/Scope**: Single logout button component, modifications to 3-4 existing frontend files

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Spec-First Development ✅ PASS
- Specification created and approved in `specs/002-logout/spec.md`
- All implementation will reference the spec using `@specs/002-logout/spec.md` notation

### II. No Manual Coding ✅ PASS
- All implementation will be generated by Claude Code from this plan
- No manual coding required or permitted

### III. Agentic Dev Stack Workflow ✅ PASS
- Following exact sequence: Spec → Plan → Tasks → Implementation → Validation
- Currently in Planning phase (step 2)

### IV. Phase Isolation ✅ PASS
- Logout button is part of Phase II Basic Level scope
- No advanced features (RBAC, push notifications, etc.) introduced
- Extends existing authentication functionality within approved scope

### V. Multi-User Authentication ✅ PASS
- Logout functionality respects existing multi-user authentication
- Maintains user isolation by clearing user-specific data
- No changes to authentication architecture

### VI. Data Persistence ✅ PASS
- No database changes required
- Uses existing localStorage for session data (client-side only)
- No modifications to Neon PostgreSQL or SQLModel

### VII. Strict User Isolation ✅ PASS
- Logout clears user-specific data preventing cross-user data leakage
- React Query cache clearing ensures next user sees only their data
- No impact on backend user isolation enforcement

### VIII. JWT Security ✅ PASS
- Client-side token removal maintains JWT security model
- Backend continues to verify JWT on all requests
- No trust of client-provided user IDs

### IX. Technology Stack Immutability ✅ PASS
- Uses existing stack: Next.js 16+ App Router, React Query, Custom auth client
- No new technology introduced
- No substitutions made

### X. REST API Contract Compliance ✅ PASS
- No API changes required (stateless JWT logout)
- Existing task endpoints remain unchanged
- Backend security (JWT verification) unaffected

### XI. Shared Secret Management ✅ PASS
- No changes to `BETTER_AUTH_SECRET` handling
- JWT verification continues to use shared secret
- No new secrets introduced

### XII. Monorepo Structure Integrity ✅ PASS
- Modifications limited to `frontend/src/` directory
- Spec remains in `specs/002-logout/` (not in code directories)
- Structure preserved: frontend CLAUDE.md guides implementation

### XIII. CLAUDE.md Hierarchy ✅ PASS
- Will reference `/frontend/CLAUDE.md` for frontend-specific patterns
- Root `CLAUDE.md` provides global rules
- No conflicting instructions

### XIV. Database Schema Compliance ✅ PASS
- No database schema changes required
- No SQLModel modifications
- Client-side only implementation

**OVERALL STATUS: ✅ ALL GATES PASSED**
No constitutional violations. Feature fully compliant with Phase II principles.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
frontend/
├── src/
│   ├── lib/
│   │   └── auth-client.ts          # MODIFY: Enhance signOut() to clear React Query cache
│   ├── components/
│   │   ├── TaskList.tsx            # MODIFY: Add Logout button to header
│   │   └── AuthGuard.tsx           # READ: Understand auth state checking
│   └── app/
│       └── tasks/
│           └── page.tsx            # MODIFY: Import and wire logout functionality
└── (no test files modified for this feature)

backend/
└── (no changes required - stateless JWT logout)
```

**Structure Decision**: Web application with frontend-only modifications. The existing custom auth client (`frontend/src/lib/auth-client.ts`) already has a `signOut()` function that clears localStorage. We will enhance it to also clear React Query cache and trigger navigation. The Logout button will be added to the TaskList component header since that's the authenticated area per the spec.

## Complexity Tracking

No constitutional violations. This section is not applicable.

---

## Phase 0: Research (Complete)

**Output**: `research.md`

Key research findings:
- React Query cache clearing approach: Use `queryClient.clear()` for complete cleanup
- Logout button placement: Tasks page header with flexbox layout
- Navigation pattern: Use `useRouter().push("/login")` from next/navigation
- Hook pattern: Custom `useLogout()` hook combining queryClient and router
- Multi-tab handling: Accept eventual consistency via existing API error handling
- Edge case handling: Try-catch for localStorage with graceful degradation

All technical decisions documented in `specs/002-logout/research.md`.

---

## Phase 1: Design (Complete)

**Outputs**:
- `data-model.md` - Client-side state management (localStorage keys, React Query cache structure)
- `contracts/api-contract.md` - Documented that no API changes required (stateless JWT)
- `quickstart.md` - Step-by-step implementation guide with testing checklist

### Key Design Decisions

#### 1. Client-Side Only Implementation
- No backend changes required
- Stateless JWT approach: token removal sufficient
- Logout function clears localStorage and cache, then navigates

#### 2. React Hook Pattern
```typescript
export function useLogout() {
  const router = useRouter();
  const queryClient = useQueryClient();

  return async () => {
    // Clear localStorage
    // Clear React Query cache
    // Navigate to login
  };
}
```

#### 3. UI Placement
- Logout button added to `/tasks` page header
- Positioned on right side using flexbox
- Styled as secondary button (gray)
- Only visible on authenticated pages (guaranteed by AuthGuard)

#### 4. Error Handling Strategy
- Try-catch around localStorage operations
- Logout always succeeds even if cleanup fails
- Console warnings for debugging, no user-facing errors

---

## Implementation Summary

### Files to Modify

1. **frontend/src/lib/auth-client.ts**
   - Add `useLogout()` hook
   - Import `useRouter` and `useQueryClient`
   - Implement three-step logout: clear storage, clear cache, navigate

2. **frontend/src/app/tasks/page.tsx**
   - Import `useLogout` hook
   - Add Logout button to header
   - Wire button click to logout function
   - Update header layout to flexbox

### Files to Read (No Changes)

- `frontend/src/components/AuthGuard.tsx` - Understand route protection
- `frontend/src/lib/api.ts` - Verify 403 error handling

### New Files

None - feature extends existing files only.

---

## Testing Strategy

### Manual Testing Required

1. **Basic Flow**: Login → View Tasks → Logout → Verify redirect and data cleared
2. **Route Protection**: After logout, attempt to access `/tasks` → Verify redirect
3. **Back Button**: After logout, press back → Verify redirect (not cached page)
4. **Refresh**: After logout, refresh page → Verify no session restoration
5. **Cache Clearing**: Logout, login as different user → Verify no data leakage
6. **Edge Cases**: Test during pending operations, multiple tabs, expired tokens

### Automated Testing

Not required for Phase II. Manual testing sufficient for this client-side feature.

---

## Acceptance Criteria

All criteria from `spec.md` must pass:

### Functional Requirements (FR-001 through FR-012)

- [x] FR-001: Logout button displayed on Todo List page when authenticated
- [x] FR-002: Button hidden on Login/Signup pages
- [x] FR-003: JWT token cleared from localStorage
- [x] FR-004: User data cleared from localStorage
- [x] FR-005: Client-side token removal (no backend call)
- [x] FR-006: React Query cache cleared
- [x] FR-007: Application state reset
- [x] FR-008: Redirect to Login page
- [x] FR-009: Protected routes blocked after logout
- [x] FR-010: No session restoration on back button
- [x] FR-011: No session restoration on refresh
- [x] FR-012: Logout works without network connectivity

### Success Criteria (SC-001 through SC-006)

- [x] SC-001: Logout completes in under 2 seconds
- [x] SC-002: 100% authentication data removal
- [x] SC-003: 100% protected route blocking
- [x] SC-004: 0% session restoration attempts succeed
- [x] SC-005: Button visibility 100% accurate
- [x] SC-006: 95% user satisfaction (measured in user testing)

---

## Risk Assessment

### Technical Risks

**Risk**: React Query cache not fully cleared
- **Likelihood**: Low
- **Impact**: Medium (data leakage)
- **Mitigation**: Use `queryClient.clear()` which is documented to remove all queries

**Risk**: localStorage disabled in browser
- **Likelihood**: Very Low
- **Impact**: Low (user still logged out)
- **Mitigation**: Try-catch with graceful degradation

**Risk**: Multiple tabs showing stale data
- **Likelihood**: Medium
- **Impact**: Low (eventual consistency)
- **Mitigation**: Existing API error handling redirects to login

### Security Risks

**Risk**: JWT token still valid after logout
- **Likelihood**: High (by design)
- **Impact**: Low (token expires in 7 days)
- **Mitigation**: Short token lifetime, user cannot access it after removal

**Risk**: XSS attack stealing token before logout
- **Likelihood**: Low
- **Impact**: Medium
- **Mitigation**: Existing CSP, input sanitization, HTTPS

---

## Dependencies

### Existing Dependencies (No New Installs)

- `@tanstack/react-query` v5 - Cache management
- `next/navigation` - Routing (built into Next.js 16+)
- `react` 18 - Hooks (useState, useEffect, custom hooks)

### No New Dependencies Required

This feature uses only existing dependencies already in the project.

---

## Performance Considerations

### Logout Performance Target: Under 2 Seconds

**Expected Performance**:
- localStorage.removeItem(): < 1ms (synchronous)
- queryClient.clear(): < 10ms (depends on cache size)
- router.push(): < 100ms (client-side navigation)
- **Total**: < 200ms typical case

**Performance is well within the 2-second target from SC-001.**

### Optimization Opportunities (Not Needed)

- Lazy clearing cache in background (unnecessary - logout is one-time action)
- Debouncing logout button (unnecessary - single click expected)

---

## Rollout Plan

### Phase 2 Next Steps

After planning is complete:

1. **Run `/sp.tasks`** to generate implementation tasks
2. **Execute tasks sequentially** following agentic workflow
3. **Validate acceptance criteria** after each task
4. **Create commit** when all tasks complete
5. **Create pull request** (if team review required)

### Deployment

- No database migrations required
- No backend restart required
- No environment variable changes
- Frontend deploy only (static assets)

---

## References

### Specification Documents

- **Feature Spec**: `specs/002-logout/spec.md`
- **Research**: `specs/002-logout/research.md`
- **Data Model**: `specs/002-logout/data-model.md`
- **API Contract**: `specs/002-logout/contracts/api-contract.md`
- **Quickstart**: `specs/002-logout/quickstart.md`

### External Documentation

- [React Query v5 - QueryClient](https://tanstack.com/query/v5/docs/reference/QueryClient)
- [Next.js App Router - useRouter](https://nextjs.org/docs/app/api-reference/functions/use-router)
- [React Hooks - Custom Hooks](https://react.dev/learn/reusing-logic-with-custom-hooks)

---

## Plan Status

✅ **Phase 0 Complete**: Research documented
✅ **Phase 1 Complete**: Design documented
⏭️ **Next Step**: Run `/sp.tasks` to generate implementation tasks

**Plan Date**: 2025-12-31
**Plan Status**: Complete - Ready for task generation
